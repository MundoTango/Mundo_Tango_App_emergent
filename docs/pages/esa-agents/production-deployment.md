# Production Deployment Configuration

## Overview

The ESA 61x21 Multi-Agent System is configured for production deployment on Replit with autoscaling, health monitoring, and optimized resource management.

## Deployment Configuration

### Replit Autoscale Setup

**File:** `.replit` (auto-generated by deploy_config_tool)

```toml
[deployment]
deploymentTarget = "autoscale"
build = ["npm", "run", "build"]
run = ["npm", "run", "start"]
```

**Build Command:**
```bash
npm run build
# Runs: vite build
# Output: dist/ folder with optimized frontend assets
```

**Start Command:**
```bash
npm run start
# Runs: node server/index.js
# Serves production build with Express
```

### Production Configuration

**File:** `server/production-config.ts`

```typescript
export const productionConfig = {
  server: {
    port: process.env.PORT || 5000,
    host: '0.0.0.0',
    trustProxy: true,
    timeout: 30000,
    keepAliveTimeout: 65000
  },
  
  database: {
    maxConnections: 20,
    idleTimeout: 10000,
    connectionTimeout: 5000,
    statementTimeout: 30000
  },
  
  agents: {
    maxConcurrentJobs: 10,
    jobTimeout: 60000,
    retryAttempts: 3
  },
  
  openai: {
    apiKey: process.env.OPENAI_API_KEY,
    maxTokens: 2000,
    rateLimit: {
      maxRequests: 100,
      windowMs: 60000
    }
  },
  
  autoscaling: {
    minInstances: 1,
    maxInstances: 10,
    targetCPU: 70,
    targetMemory: 80
  }
};
```

## Health Check Endpoints

### /health

Comprehensive health check for load balancers:

**Response (200 OK):**
```json
{
  "status": "healthy",
  "timestamp": "2025-10-05T10:00:00.000Z",
  "checks": {
    "database": "connected",
    "agents": "healthy",
    "memory": {
      "rss": 145678912,
      "heapTotal": 89456640,
      "heapUsed": 67234816,
      "external": 1234567
    },
    "uptime": 3600.5
  }
}
```

**Response (503 Service Unavailable):**
```json
{
  "status": "unhealthy",
  "error": "Database connection failed",
  "timestamp": "2025-10-05T10:00:00.000Z"
}
```

**Health Checks Performed:**
1. Database connectivity test
2. Agent system status
3. Memory usage check
4. Process uptime

### /ready

Readiness probe for Kubernetes/Replit:

**Response (200 OK):**
```json
{
  "ready": true,
  "timestamp": "2025-10-05T10:00:00.000Z"
}
```

**Response (503 Service Unavailable):**
```json
{
  "ready": false,
  "error": "Database not ready",
  "timestamp": "2025-10-05T10:00:00.000Z"
}
```

**Checks:**
- Database connection active
- Migrations completed
- Essential services initialized

### /live

Liveness probe for process health:

**Response (200 OK):**
```json
{
  "alive": true,
  "timestamp": "2025-10-05T10:00:00.000Z",
  "pid": 12345,
  "uptime": 3600.5
}
```

**Purpose:**
- Verify process is running
- Detect crashed instances
- Trigger container restart if needed

## Autoscaling Configuration

### Scaling Triggers

**Scale Up When:**
- CPU usage > 70% for 60 seconds
- Memory usage > 80% for 60 seconds
- Request queue depth > 50
- Response time > 2 seconds consistently

**Scale Down When:**
- CPU usage < 30% for 300 seconds
- Memory usage < 40% for 300 seconds
- No requests for 5 minutes
- All metrics stable and low

### Instance Configuration

```typescript
autoscaling: {
  minInstances: 1,              // Always keep at least 1 running
  maxInstances: 10,             // Scale up to 10 for high load
  targetCPU: 70,                // Target 70% CPU utilization
  targetMemory: 80,             // Target 80% memory utilization
  scaleUpPeriod: 60,            // 60s before scaling up
  scaleDownPeriod: 300,         // 5min before scaling down
  healthCheckInterval: 30000,   // Check health every 30s
  healthCheckTimeout: 5000,     // Timeout after 5s
}
```

### Startup Probe

```typescript
startupProbe: {
  path: '/health',
  initialDelaySeconds: 10,      // Wait 10s before first check
  periodSeconds: 10,            // Check every 10s
  failureThreshold: 3           // Fail after 3 consecutive failures
}
```

## Environment Variables

### Required Variables

```bash
# Database (Auto-configured by Replit)
DATABASE_URL=postgresql://...
PGHOST=...
PGDATABASE=...
PGUSER=...
PGPASSWORD=...

# OpenAI (Required)
OPENAI_API_KEY=sk-...

# Session & JWT
SESSION_SECRET=your-secret-key
JWT_SECRET=your-jwt-secret

# Node Environment
NODE_ENV=production
PORT=5000
```

### Optional Variables

```bash
# Performance
MAX_CONNECTIONS=20
CACHE_TTL=3600

# Security
CORS_ORIGINS=https://yourdomain.com
ENABLE_CSRF=true

# Monitoring
LOG_LEVEL=warn
ENABLE_METRICS=true
METRICS_PORT=9090

# Features
ENABLE_AGENTS=true
ENABLE_WEBSOCKETS=true
ENABLE_FILE_UPLOADS=true
```

## Build Process

### 1. Frontend Build

```bash
npm run build
```

**Process:**
1. Vite compiles React app
2. TypeScript transpilation
3. Asset optimization
4. Code splitting
5. Production minification

**Output:**
```
dist/
├── index.html
├── assets/
│   ├── index-[hash].js
│   ├── index-[hash].css
│   └── [other-chunks]
└── [static-assets]
```

### 2. Server Preparation

No build step needed for server (uses `tsx` runtime):

```bash
node --max-old-space-size=4096 server/index.js
```

**Features:**
- 4GB heap allocation
- Garbage collection optimization
- Production error handling
- Compression enabled

### 3. Static File Serving

```typescript
// In production, serve pre-built files
if (process.env.NODE_ENV === 'production') {
  app.use(express.static('dist'));
  
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, '../dist/index.html'));
  });
}
```

## Performance Optimizations

### Compression

```typescript
import compression from 'compression';

app.use(compression({
  level: 6,                    // Balanced compression
  threshold: 1024,             // Compress files > 1KB
  filter: (req, res) => {
    if (req.headers['x-no-compression']) {
      return false;
    }
    return compression.filter(req, res);
  }
}));
```

### Caching Headers

```typescript
app.use(express.static('dist', {
  maxAge: '1y',               // Cache assets for 1 year
  immutable: true,            // Assets never change (hash in filename)
  etag: false,                // Disable ETags for performance
  lastModified: false
}));

// API responses - no cache
app.use('/api', (req, res, next) => {
  res.set('Cache-Control', 'no-store, no-cache, must-revalidate');
  next();
});
```

### Database Connection Pooling

```typescript
const pool = new Pool({
  max: 20,                     // Max connections
  idleTimeoutMillis: 10000,    // Close idle connections after 10s
  connectionTimeoutMillis: 5000 // Timeout connection attempts
});
```

### Memory Management

```typescript
// Expose garbage collection
node --expose-gc --max-old-space-size=4096 server/index.js

// Trigger GC on high memory usage
if (process.memoryUsage().heapUsed > 3.5 * 1024 * 1024 * 1024) {
  if (global.gc) {
    global.gc();
  }
}
```

## Security

### Helmet Configuration

```typescript
import helmet from 'helmet';

app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.openai.com"]
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

### Rate Limiting

```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,    // 15 minutes
  max: 100,                     // Limit each IP to 100 requests per windowMs
  message: 'Too many requests, please try again later'
});

app.use('/api/', limiter);
```

### CORS

```typescript
import cors from 'cors';

app.use(cors({
  origin: process.env.CORS_ORIGINS?.split(',') || '*',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));
```

## Monitoring & Logging

### Production Logging

```typescript
import pino from 'pino';

const logger = pino({
  level: process.env.LOG_LEVEL || 'warn',
  transport: {
    target: 'pino-pretty',
    options: {
      colorize: false,
      translateTime: 'SYS:standard'
    }
  }
});

// Log errors only in production
app.use((err, req, res, next) => {
  logger.error({
    err,
    req: {
      method: req.method,
      url: req.url,
      headers: req.headers
    }
  });
  
  res.status(500).json({ error: 'Internal server error' });
});
```

### Prometheus Metrics

Expose metrics for scraping:

```typescript
app.get('/metrics', async (req, res) => {
  res.set('Content-Type', register.contentType);
  res.send(await register.metrics());
});
```

## Deployment Checklist

### Pre-Deployment

- [ ] All tests passing
- [ ] Environment variables configured
- [ ] Database migrations applied
- [ ] Build process successful
- [ ] Health checks working locally
- [ ] Security headers configured
- [ ] Rate limiting enabled
- [ ] Error tracking setup

### Deployment

- [ ] Push to main branch
- [ ] Click "Publish" in Replit
- [ ] Verify build completes
- [ ] Check health endpoint returns 200
- [ ] Test key user flows
- [ ] Monitor initial traffic
- [ ] Check error logs

### Post-Deployment

- [ ] Verify autoscaling works
- [ ] Monitor response times
- [ ] Check OpenAI token usage
- [ ] Review error rates
- [ ] Test from different regions
- [ ] Update documentation
- [ ] Communicate to team

## Troubleshooting

### Build Failures

**Issue:** Vite build fails
```bash
# Check for TypeScript errors
npm run typecheck

# Check for missing dependencies
npm install

# Clear cache and rebuild
rm -rf dist node_modules
npm install
npm run build
```

**Issue:** Import errors in production
```
# Verify all paths use aliases correctly
import { Button } from '@/components/ui/button';  ✓
import { Button } from '../../components/ui/button';  ✗
```

### Runtime Errors

**Issue:** Server won't start
```bash
# Check environment variables
env | grep -E "DATABASE_URL|OPENAI_API_KEY"

# Check database connection
curl http://localhost:5000/health

# View logs
tail -f /tmp/logs/*.log
```

**Issue:** High memory usage
```bash
# Trigger garbage collection
kill -SIGUSR2 <pid>

# Restart with lower memory limit
node --max-old-space-size=2048 server/index.js
```

### Performance Issues

**Issue:** Slow response times
1. Check database query performance
2. Review agent processing times
3. Verify caching is working
4. Scale up instances

**Issue:** High CPU usage
1. Profile with Node.js inspector
2. Optimize hot paths
3. Increase autoscale instances
4. Consider horizontal scaling

## Rollback Procedure

If deployment fails:

1. **Immediate:** Revert to previous deployment via Replit UI
2. **Investigate:** Check logs for error root cause
3. **Fix:** Apply fix locally and test
4. **Redeploy:** Push fix and deploy again
5. **Monitor:** Watch metrics closely

## Future Enhancements

- [ ] Blue-green deployment strategy
- [ ] Canary releases for gradual rollout
- [ ] Automated rollback on errors
- [ ] Multi-region deployment
- [ ] CDN integration for static assets
- [ ] Database read replicas
- [ ] Redis caching layer (if needed)