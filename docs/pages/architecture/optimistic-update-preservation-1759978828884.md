# optimistic-update-preservation

**Date:** 2025-10-09  
**ESA Layers:** 7, 14  
**Agent Domains:** frontend, infrastructure  
**Confidence:** 92.0%  
**Discovered By:** frontend

## Problem

When invalidating queries, optimistic updates were being lost because refetch would overwrite the optimistically updated UI with stale data from the server. This caused flickering and poor UX during mutations.

## Solution

Preserve existing optimistic values during cache updates using nullish coalescing. Pattern: post.likes ?? post.likesCount ensures the optimistically incremented 'likes' field is kept if it exists, falling back to 'likesCount' from server only if no optimistic update is present. This maintains instant UI feedback while waiting for server confirmation.

## Code Example

```typescript
// Preserve optimistic updates during refetch
queryClient.setQueryData(
  ['/api/posts', postId],
  (old: Post | undefined) => {
    if (!old) return old;
    return {
      ...old,
      // Preserve optimistic 'likes' if exists, otherwise use 'likesCount' from server
      likes: old.likes ?? old.likesCount,
      // Same pattern for all optimistic fields
      comments: old.comments ?? old.commentsCount,
    };
  }
);
```

## Success Metrics

- **uiConsistency:** maintained
- **userExperience:** seamless
- **flickeringEliminated:** 100%

## Related Patterns

- [segment-aware-query-matching](../learnings/segment-aware-query-matching.md)
- [cross-surface-sync](../learnings/cross-surface-sync.md)

## Applied To

```json
{
  "files": [
    "client/src/hooks/usePostLike.ts",
    "client/src/hooks/useCommentMutation.ts",
    "client/src/hooks/useEventRSVP.ts"
  ],
  "components": [
    "usePostLike",
    "useCommentMutation",
    "useEventRSVP"
  ]
}
```

---

*Auto-generated by ESA Agent Learning System on 2025-10-09*
