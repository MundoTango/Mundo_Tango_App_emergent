import type { AgentHandler } from "../../../../common/agent-types";
function fakeSessionId(){ return "sess_test_"+Math.random().toString(36).slice(2); }
export const handler: AgentHandler = async (input, ctx) => { const { supabase, log, emit }=ctx; const { user_id, amount_cents, currency="usd" }=input as any; if(!amount_cents||amount_cents<50) return { status:"fail", error:{ code:"amount_too_small" } }; const session_id=fakeSessionId(); const { data, error }=await supabase.from("payments").insert({ user_id, amount: amount_cents, currency, stripe_session_id: session_id, status:"pending" }).select().single(); if(error) return { status:"fail", error:{ code:"db_error", message:error.message } }; await emit("payments.checkout.created",{ payment_id:data.id, session_id, amount_cents, currency }); return { status:"ok", data:{ payment_id:data.id, session_id } }; };